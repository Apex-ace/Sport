{% extends 'base.html' %}
{% block title %}Book {{ game.name }}{% endblock %}

{% block head_styles %}
<style>
    .form-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 1rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }
    .loading-spinner { display: none; }
    .btn-book.loading .loading-spinner { display: inline-block; }
</style>
{% endblock %}

{% block content %}
<main class="flex justify-center items-center min-h-full p-4 sm:p-6">
    <div class="w-full max-w-xl sm:max-w-2xl">
        <div class="bg-white p-6 sm:p-8 md:p-10 rounded-3xl shadow-2xl">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 text-center mb-6">
                Book {{ game.name }}
            </h1>
            
            <form method="POST" action="{{ url_for('book_game', game_id=game.id) }}" id="bookingForm" class="space-y-6 sm:space-y-8">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <!-- Date + Time Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 sm:gap-8">
                    <!-- Date Picker -->
                    <div>
                        <label for="booking_date" class="block text-sm sm:text-base font-semibold mb-2 sm:mb-3">Select Date</label>
                        <input type="date" id="booking_date" name="booking_date" required min="{{ today }}" 
                               class="w-full px-3 sm:px-4 py-3 sm:py-4 rounded-2xl border-2 text-sm sm:text-base">
                    </div>
                    
                    <!-- Time Slots -->
                    <div>
                        <label for="booking_time" class="block text-sm sm:text-base font-semibold mb-2 sm:mb-3">Available Time Slots</label>
                        <select id="booking_time" name="booking_time" required disabled 
                                class="form-select w-full px-3 sm:px-4 py-3 sm:py-4 rounded-2xl border-2 disabled:bg-gray-100 text-sm sm:text-base">
                            <option value="">Select a date first</option>
                        </select>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-4 sm:pt-6">
                    <button type="submit" id="submit-btn" disabled 
                            class="btn-book w-full flex justify-center items-center py-4 sm:py-5 px-6 sm:px-8 rounded-2xl shadow-xl font-bold text-white bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-sm sm:text-base">
                        <span class="loading-spinner w-5 h-5 sm:w-6 sm:h-6 mr-2 sm:mr-3 border-t-transparent rounded-full animate-spin border-4"></span>
                        <span class="btn-text">Confirm Booking</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('booking_date');
    const timeSelect = document.getElementById('booking_time');
    const submitButton = document.getElementById('submit-btn');
    const bookedSlots = {{ booked_slots_json|safe }};
    const isNewUser = {{ is_new_user|safe }};

    function updateAvailableSlots() {
        const selectedDateStr = dateInput.value;
        if (!selectedDateStr) {
            timeSelect.innerHTML = '<option value="">Select a date first</option>';
            timeSelect.disabled = true;
            submitButton.disabled = true;
            return;
        }
        
        const selectedDate = new Date(selectedDateStr + 'T00:00:00Z');
        const weekday = selectedDate.getUTCDay(); // Sunday = 0, ..., Friday = 5

        let potentialSlots = [];
        if (weekday >= 1 && weekday <= 4) { 
            potentialSlots = ['16:00', '16:30']; 
        } else if (weekday === 5) { 
            potentialSlots = ['14:00', '14:30', '15:00', '15:30', '16:00', '16:30']; 
        }
        
        const prioritySlots = {
            '3': ['16:00'],          // Wednesday 4 PM
            '5': ['15:00', '16:30']  // Friday 3 PM & 4:30 PM
        };

        timeSelect.innerHTML = '';
        if (potentialSlots.length === 0) {
            timeSelect.innerHTML = '<option value="">No slots on weekends</option>';
            timeSelect.disabled = true;
            return;
        }
        
        let hasAvailableSlots = false;
        const now = new Date();
        potentialSlots.forEach(slot => {
            const [hours, minutes] = slot.split(':');
            const slotDateTime = new Date(selectedDateStr + `T${hours}:${minutes}:00Z`);
            
            if (slotDateTime < now) return;
            
            const option = document.createElement('option');
            option.value = slot;

            const isPrioritySlot = (prioritySlots[weekday] || []).includes(slot);

            if (bookedSlots.includes(slotDateTime.toISOString())) {
                option.textContent = `${slot} - Booked`;
                option.disabled = true;
            } else if (isPrioritySlot && !isNewUser) {
                option.textContent = `${slot} - Reserved for New Users`;
                option.disabled = true;
            } else {
                option.textContent = slot + (isPrioritySlot ? ' (Priority Slot)' : '');
                hasAvailableSlots = true;
            }
            timeSelect.appendChild(option);
        });
        
        timeSelect.disabled = false;
        submitButton.disabled = !hasAvailableSlots;
    }
    dateInput.addEventListener('change', updateAvailableSlots);
    if(dateInput.value) { updateAvailableSlots(); }
});
</script>
{% endblock %}
