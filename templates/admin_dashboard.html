{% extends 'base.html' %}
{% block title %}Admin Dashboard - JIT Sports{% endblock %}

{% block head_styles %}
<style>
    .admin-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); }
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .stats-card { background: linear-gradient(135deg, #ffffff, #f8fafc); transition: all 0.3s ease; }
    .stats-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
    .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
</style>
{% endblock %}

{% block content %}
<div class="admin-gradient min-h-screen relative">
    <div class="relative z-10 container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
            <div class="mb-6 lg:mb-0">
                <h1 class="text-4xl font-bold text-white mb-2">Admin Dashboard</h1>
                <p class="text-gray-300">Oversee all user activity and manage bookings.</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <a href="{{ url_for('download_report') }}" class="inline-flex items-center justify-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-2xl shadow-lg transition-transform duration-300 hover:scale-105">
                    Download Report
                </a>
                <form action="{{ url_for('admin_logout') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="w-full inline-flex items-center justify-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-2xl shadow-lg transition-transform duration-300 hover:scale-105">
                        Logout
                    </button>
                </form>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stats-card p-6 rounded-3xl shadow-xl">
                <p class="text-gray-600 text-sm font-medium mb-1">Total Users</p>
                <p class="text-3xl font-bold text-gray-900">{{ users|length }}</p>
            </div>
            <div class="stats-card p-6 rounded-3xl shadow-xl">
                <p class="text-gray-600 text-sm font-medium mb-1">Confirmed Bookings</p>
                <p class="text-3xl font-bold text-gray-900">{{ bookings|selectattr('0.status', 'equalto', 'Confirmed')|list|length }}</p>
            </div>
            <div class="stats-card p-6 rounded-3xl shadow-xl">
                <p class="text-gray-600 text-sm font-medium mb-1">Cancelled Bookings</p>
                <p class="text-3xl font-bold text-gray-900">{{ bookings|selectattr('0.status', 'equalto', 'Cancelled')|list|length }}</p>
            </div>
             <div class="stats-card p-6 rounded-3xl shadow-xl">
                <p class="text-gray-600 text-sm font-medium mb-1">System Status</p>
                <p class="text-lg font-semibold text-green-600">Online</p>
            </div>
        </div>

        <!-- Users Table -->
        <div class="glass-card p-6 md:p-8 rounded-3xl shadow-2xl mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Registered Users</h2>
            
            <!-- Desktop Table -->
            <div class="overflow-x-auto hidden md:block">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-100">
                            <th class="text-left py-4 px-6 font-semibold text-sm uppercase">Username (Email)</th>
                            <th class="text-left py-4 px-6 font-semibold text-sm uppercase">Role</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for user in users %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-4 px-6 font-medium text-gray-900">{{ user.username }}</td>
                            <td class="py-4 px-6 text-gray-700">{{ user.role }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="2" class="py-12 text-center text-gray-500">No users have registered yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card List -->
            <div class="md:hidden space-y-4">
                {% for user in users %}
                <div class="bg-gray-50 p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-800">{{ user.username }}</span>
                        <span class="text-sm font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{{ user.role }}</span>
                    </div>
                </div>
                {% else %}
                <p class="py-8 text-center text-gray-500">No users have registered yet.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Bookings Table -->
        <div class="glass-card p-6 md:p-8 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">All Bookings</h2>
            
            <!-- Desktop Table -->
            <div class="overflow-x-auto hidden md:block">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-100">
                            <th class="text-left py-4 px-6 font-semibold text-sm uppercase">User</th>
                            <th class="text-left py-4 px-6 font-semibold text-sm uppercase">Game</th>
                            <th class="text-left py-4 px-6 font-semibold text-sm uppercase">Booking Time</th>
                            <th class="text-left py-4 px-6 font-semibold text-sm uppercase">Status</th>
                           
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for booking, user, game in bookings %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-4 px-6 font-medium text-gray-900">{{ user.username }}</td>
                            <td class="py-4 px-6 text-gray-700">{{ game.name }}</td>
                            <td class="py-4 px-6 text-gray-700">
                                {{ booking.booking_time.astimezone(timezone(timedelta(hours=5, minutes=30))).strftime('%b %d, %Y - %I:%M %p') }}
                            </td>
                            <td class="py-4 px-6">
                                {% if booking.status == 'Confirmed' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Confirmed</span>
                                {% elif booking.status == 'Cancelled' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Cancelled</span>
                                {% endif %}
                            </td>
                            <td class="py-4 px-6">
                                {% if booking.status == 'Confirmed' and booking.booking_time > now_utc %}
                                <button type="button" onclick="openCancelModal({{ booking.id }}, '{{ user.username }}\'s booking for {{ game.name }}')" class="text-red-600 hover:text-red-800 font-semibold text-sm">
                                    Cancel
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="py-12 text-center text-gray-500">No bookings have been made yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card List -->
            <div class="md:hidden space-y-4">
                {% for booking, user, game in bookings %}
                <div class="bg-gray-50 p-4 rounded-lg shadow space-y-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-500">User</p>
                            <p class="font-medium text-gray-900">{{ user.username }}</p>
                        </div>
                        {% if booking.status == 'Confirmed' %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Confirmed</span>
                        {% elif booking.status == 'Cancelled' %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Cancelled</span>
                        {% endif %}
                    </div>
                     <div>
                        <p class="text-sm text-gray-500">Game</p>
                        <p class="font-medium text-gray-900">{{ game.name }}</p>
                    </div>
                     <div>
                        <p class="text-sm text-gray-500">Time</p>
                        <p class="font-medium text-gray-900">{{ booking.booking_time.astimezone(timezone(timedelta(hours=5, minutes=30))).strftime('%b %d, %Y - %I:%M %p') }}</p>
                    </div>
                    {% if booking.status == 'Confirmed' and booking.booking_time > now_utc %}
                    <div class="pt-2 border-t border-gray-200">
                        
                    </div>
                    {% endif %}
                </div>
                {% else %}
                 <p class="py-8 text-center text-gray-500">No bookings have been made yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Cancellation Modal -->
<div id="cancel-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
        <div class="text-center">
            <h3 class="text-2xl font-bold text-gray-900">Cancel Booking?</h3>
            <p class="text-gray-600 mt-4">
                Are you sure you want to cancel <strong id="modal-booking-info" class="text-gray-800"></strong>? This action cannot be undone.
            </p>
        </div>
        <div class="mt-8 grid grid-cols-2 gap-4">
            <button onclick="closeCancelModal()" type="button" class="w-full justify-center rounded-xl border px-4 py-3 bg-white font-medium text-gray-700 hover:bg-gray-50">Go Back</button>
            <!-- <form id="cancel-form" method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="w-full justify-center rounded-xl border border-transparent px-4 py-3 bg-red-600 font-medium text-white hover:bg-red-700">Yes, Cancel Booking</button>
            </form> -->
        </div>
    </div>
</div>

<script>
    const cancelModal = document.getElementById('cancel-modal');
    const cancelForm = document.getElementById('cancel-form');
    const modalBookingInfo = document.getElementById('modal-booking-info');

    function openCancelModal(bookingId, bookingInfo) {
        cancelForm.action = `/cancel_booking/${bookingId}`;
        modalBookingInfo.textContent = bookingInfo;
        cancelModal.classList.remove('hidden');
    }

    function closeCancelModal() {
        cancelModal.classList.add('hidden');
    }

    cancelModal.addEventListener('click', (e) => {
        if (e.target === cancelModal) {
            closeCancelModal();
        }
    });
</script>
{% endblock %}

